APP_NAME = "PrintingAlley"
KEYCHAIN_NAME = ENV["KEYCHAIN_NAME"]
KEYCHAIN_PASSWORD = ENV["KEYCHAIN_PASSWORD"]
DEV_SCHEME = "PrintingAlley-DEV"
PROD_SCHEME = "PrintingAlley-PROD"

# âœ… ê¸°ë³¸ í”Œë«í¼ì„ ios ë¡œ ì„¤ì •í•˜ì—¬ fastlane [lane name] ìœ¼ë¡œ ì‰½ê²Œ ì‹¤í–‰ê°€ëŠ¥.(ì›ë˜ fastlane [platfrom name] [lane name] ìœ¼ë¡œ ì‹¤í–‰í•´ì•¼ í•¨)
default_platform(:ios)


platform :ios do 
  # âœ… ì¸ì¦ì„œë¥¼ í‚¤ì²´ì¸ì— ì €ì¥í•˜ê¸°
  desc "Save To Keychain"
  lane :set_keychain do
    create_keychain(
      name: "#{KEYCHAIN_NAME}", # ìƒˆë¡œ ìƒì„±ë  í‚¤ì²´ì¸ì˜ ì´ë¦„ì„ ì§€ì •í•©ë‹ˆë‹¤. 
      password: "#{KEYCHAIN_PASSWORD}", # ìƒˆë¡œìš´ í‚¤ì²´ì¸ì„ ë§Œë“¤ ë•Œ ì„¤ì •í•  ë¹„ë°€ë²ˆí˜¸ë¥¼ ì§€ì •í•©ë‹ˆë‹¤
      default_keychain: true, # ì™„ì„±ëœ í‚¤ì²´ì¸ì„ ì‹œìŠ¤í…œì˜ ê¸°ë³¸ í‚¤ì²´ì¸ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
      unlock: true, # í‚¤ì²´ì¸ì„ ìƒì„±í•œ í›„ì— ìë™ìœ¼ë¡œ ì–¸ë½í•©ë‹ˆë‹¤. ì¦‰, ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì§€ ì•Šê³ ë„ í•´ë‹¹ í‚¤ì²´ì¸ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
      timeout: 3600, # í‚¤ì²´ì¸ì´ ì–¸ë½ëœ ìƒíƒœë¥¼ ìœ ì§€í•˜ëŠ” ì‹œê°„ì„ ì§€ì •í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” 3600ì´ˆ(1ì‹œê°„) ë™ì•ˆ ì–¸ë½ ìƒíƒœë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.
      lock_when_sleeps: false #  ì‹œìŠ¤í…œì´ ìŠ¬ë¦½ ëª¨ë“œë¡œ ë“¤ì–´ê°ˆ ë•Œ í‚¤ì²´ì¸ì„ ì ê·¸ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.
    )

      # âœ… ì¸ì¦ì„œë¥¼ íŠ¹ì • í‚¤ì²´ì¸ì— ê°€ì ¸ì˜¤ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. 
      import_certificate(
        certificate_path: "Tuist/Signing/#{APP_NAME}.PROD.cer", # ê°€ì ¸ì˜¬ ì¸ì¦ì„œì˜ ê²½ë¡œë¥¼ ì§€ì •í•©ë‹ˆë‹¤. ì´ëŠ” ë¡œì»¬ íŒŒì¼ ì‹œìŠ¤í…œì— ìˆëŠ” ì¸ì¦ì„œ íŒŒì¼ì˜ ê²½ë¡œì—¬ì•¼ í•©ë‹ˆë‹¤.
        keychain_name: "#{KEYCHAIN_NAME}", # ì¸ì¦ì„œë¥¼ ê°€ì ¸ì˜¬ í‚¤ì²´ì¸ì˜ ì´ë¦„ì„ ì§€ì •í•©ë‹ˆë‹¤. í•´ë‹¹ í‚¤ì²´ì¸ì€ ì´ë¯¸ ìƒì„±ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. 
        keychain_password: "#{KEYCHAIN_PASSWORD}" # í‚¤ì²´ì¸ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ì´ ë¹„ë°€ë²ˆí˜¸ëŠ” í‚¤ì²´ì¸ì„ ì–¸ë½í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.
      )

      import_certificate(
        certificate_path: "Tuist/Signing/#{APP_NAME}.PROD.p12",
        keychain_name: "#{KEYCHAIN_NAME}",
        keychain_password: "#{KEYCHAIN_PASSWORD}"
      )

      # âœ… í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ì„ íŠ¹ì • ìœ„ì¹˜ì— ì„¤ì¹˜í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤
      install_provisioning_profile(path: "Tuist/Signing/#{APP_NAME}.PROD.mobileprovision")
      
    end

      
  #     #key_id: App Store Connect API í‚¤ì˜ IDì…ë‹ˆë‹¤. ì´ëŠ” Apple Developer ê³„ì •ì—ì„œ ìƒì„±ëœ í‚¤ì— ëŒ€í•œ ê³ ìœ  ì‹ë³„ìì…ë‹ˆë‹¤.
      
  #     #issuer_id: App Store Connect API í‚¤ì˜ ë°œí–‰ì IDì…ë‹ˆë‹¤. ì´ëŠ” Apple Developer ê³„ì •ì—ì„œ ìƒì„±ëœ í‚¤ì— ëŒ€í•œ ë°œí–‰ìë¥¼ ë‚˜íƒ€ë‚´ëŠ” ê³ ìœ  ì‹ë³„ìì…ë‹ˆë‹¤.
      
  #     #key_filepath: App Store Connect API í‚¤ íŒŒì¼ì˜ ê²½ë¡œì…ë‹ˆë‹¤. ì´ íŒŒì¼ì€ ê°œì¸ í‚¤ë¡œ, .p8 í™•ì¥ìë¥¼ ê°€ì§„ í‚¤ íŒŒì¼ì¼ ê²ƒì…ë‹ˆë‹¤.
      
  #     #duration: ì„ íƒì  ë§¤ê°œë³€ìˆ˜ë¡œ, ìƒì„±ëœ API í† í°ì˜ ìˆ˜ëª…ì„ ì§€ì •í•©ë‹ˆë‹¤. ê¸°ë³¸ê°’ì€ 1200ì´ˆ(20ë¶„)ì…ë‹ˆë‹¤. í•„ìš”ì— ë”°ë¼ ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      
  #     #in_house: ì„ íƒì  ë§¤ê°œë³€ìˆ˜ë¡œ, trueë¡œ ì„¤ì •í•˜ë©´ In-House ì•± ë°°í¬ë¥¼ ìœ„í•œ í‚¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ê¸°ë³¸ê°’ì€ falseì…ë‹ˆë‹¤.
      
  desc "Push a new beta build to TestFlight"
  lane :beta do 

  #   # âœ… ì•±ìŠ¤í† ì–´ ì»¤ë„¥íŠ¸ í‚¤ ì—°ê²°
  #   # App Store Connect APIë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ API í‚¤ë¥¼ ë¡œë“œí•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹¤ë¥¸ fastlane ë„êµ¬ ë° ì•¡ì…˜ì—ì„œ Apple ê³„ì •ê³¼ ìƒí˜¸ ì‘ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 
    api_key = app_store_connect_api_key(is_key_content_base64: true, in_house: false)

    build_number = latest_testflight_build_number(app_identifier: ENV["APP_IDENTIFIER"]) + 1
  #   # âœ… ë¹Œë“œ ë„˜ë²„ ì¦ê°€
    increment_build_number({
        build_number: build_number,
        xcodeproj: "Projects/App/#{APP_NAME}.xcodeproj"
  })
  
   echo(message:"âœ… build_number = #{build_number}") # ì¶œë ¥

    build_app(
      workspace: "#{APP_NAME}.xcworkspace",
      scheme: "#{PROD_SCHEME}",
      export_method: "app-store" #  ì•± ìŠ¤í† ì–´ì— ì•±ì„ ì œì¶œí•˜ê¸° ìœ„í•œ ëª©ì ìœ¼ë¡œ ì•„ì¹´ì´ë¸Œë¥¼ ë‚´ë³´ëƒ…ë‹ˆë‹¤.
    )

    upload_to_testflight(
      api_key: api_key,
      distribute_external: true,
      build_number: "#{build_number}",
      groups: ["ì™¸ë¶€ í…ŒìŠ¤íŠ¸ ê·¸ë£¹1"],
      changelog: "- í…ŒìŠ¤íŠ¸"
    )

  discord_notifier(
      webhook_url: ENV["WEBHOOK_URL"],
      title: "ğŸš€ ì¸ì‡„ê³¨ëª© iOS í…ŒìŠ¤íŠ¸ í”Œë¼ì‡ ìë™í™” ì„±ê³µ",
      thumbnail_url: "https://github.com/PrintingAlley/PrintingAlley-iOS/assets/48616183/ccfab207-7ae8-4aa5-8f7c-c0e56ba8206e",
      description: "ì¸ì‡„ê³¨ëª© iOS #{build_number}ì„ ì•±ìŠ¤í† ì–´ì— ì„±ê³µì ìœ¼ë¡œ ë°°í¬í•˜ì˜€ìŠµë‹ˆë‹¤ !"
    )
  end
end